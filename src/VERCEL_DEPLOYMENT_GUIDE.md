# üöÄ Vercel Deployment Guide for Sparked Sense

## Overview

This guide covers deploying the **Sparked Sense** Web3 platform to Vercel. The architecture is:
- **Frontend**: React + TypeScript (Vercel)
- **Backend**: Supabase Edge Functions (Supabase)
- **Database**: PostgreSQL (Supabase)
- **Auth**: Supabase Auth

---

## ‚ö†Ô∏è Important Architecture Notes

### What Gets Deployed Where

| Component | Deploy To | Why |
|-----------|-----------|-----|
| Frontend (React app) | **Vercel** | Static/SSR hosting |
| Backend (Edge Functions) | **Supabase** | Serverless functions |
| Database | **Supabase** | Managed PostgreSQL |
| Authentication | **Supabase** | Built-in auth service |

**Key Point:** Supabase Edge Functions **CANNOT** be deployed to Vercel. They must remain on Supabase.

---

## üìã Prerequisites

Before deploying to Vercel, ensure:

1. ‚úÖ **Supabase Setup Complete**
   - Edge Function deployed: `supabase functions deploy server`
   - Database migration applied
   - Email confirmation disabled in Auth settings

2. ‚úÖ **GitHub Repository** (Optional but recommended)
   - Code pushed to GitHub
   - Repository set to public or Vercel has access

3. ‚úÖ **Vercel Account**
   - Free account at [vercel.com](https://vercel.com)

---

## üîß Step 1: Prepare Your Project

### 1.1 Create `vercel.json` Configuration

Create this file in your project root:

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "devCommand": "npm run dev",
  "installCommand": "npm install",
  "framework": "vite",
  "rewrites": [
    {
      "source": "/(.*)",
      "destination": "/index.html"
    }
  ]
}
```

**What this does:**
- Tells Vercel this is a Vite React app
- Configures SPA routing (all routes go to index.html)
- Sets build output directory

### 1.2 Verify `package.json` Scripts

Your `package.json` should have these scripts (if they don't exist, add them):

```json
{
  "scripts": {
    "dev": "vite",
    "build": "vite build",
    "preview": "vite preview"
  }
}
```

### 1.3 Create `.env.example`

Create this file to document required environment variables:

```bash
# Supabase Configuration
VITE_SUPABASE_URL=https://YOUR_PROJECT_ID.supabase.co
VITE_SUPABASE_ANON_KEY=your_anon_key_here
```

**Note:** Your project currently hardcodes these in `/utils/supabase/info.tsx`, which works but isn't best practice for production.

### 1.4 Add `.vercelignore` (Optional)

```
# Documentation
*.md
!README.md

# Development files
.env.local
.env.development

# Supabase (deployed separately)
supabase/

# Guidelines
guidelines/
```

---

## üöÄ Step 2: Deploy to Vercel

### Option A: Deploy via Vercel Dashboard (Recommended)

1. **Go to [Vercel Dashboard](https://vercel.com/new)**

2. **Import Git Repository**
   - Click "Add New Project"
   - Select your GitHub repository
   - Click "Import"

3. **Configure Project**
   - **Framework Preset:** Vite (should auto-detect)
   - **Root Directory:** `./` (leave as default)
   - **Build Command:** `npm run build` (auto-filled)
   - **Output Directory:** `dist` (auto-filled)
   - **Install Command:** `npm install` (auto-filled)

4. **Add Environment Variables**
   
   Click "Environment Variables" and add:
   
   | Name | Value | Source |
   |------|-------|--------|
   | `VITE_SUPABASE_URL` | `https://djzexivvddzzduetmkel.supabase.co` | From `/utils/supabase/info.tsx` |
   | `VITE_SUPABASE_ANON_KEY` | `eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...` | From `/utils/supabase/info.tsx` |

   **Important:** 
   - Add these to **all environments** (Production, Preview, Development)
   - Don't expose `SUPABASE_SERVICE_ROLE_KEY` - it should only be in Edge Functions

5. **Deploy**
   - Click "Deploy"
   - Wait 2-3 minutes for build to complete
   - Get your deployment URL: `https://your-project.vercel.app`

### Option B: Deploy via Vercel CLI

```bash
# Install Vercel CLI
npm i -g vercel

# Login to Vercel
vercel login

# Deploy to preview
vercel

# Deploy to production
vercel --prod
```

During deployment, the CLI will ask:
- **Set up and deploy?** Y
- **Which scope?** Select your account
- **Link to existing project?** N (first time) or Y (subsequent)
- **Project name?** sparked-sense (or your choice)
- **Directory?** `./` (press Enter)
- **Override settings?** N (use vercel.json)

Then manually add environment variables via dashboard.

---

## üîÑ Step 3: Update Frontend to Use Environment Variables (Optional but Recommended)

Currently, your app hardcodes Supabase credentials in `/utils/supabase/info.tsx`. For better security and flexibility:

### 3.1 Update `/utils/supabase/info.tsx`

```typescript
/* AUTOGENERATED FILE - DO NOT EDIT CONTENTS */

export const projectId = import.meta.env.VITE_SUPABASE_PROJECT_ID || "djzexivvddzzduetmkel"
export const publicAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY || "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRqemV4aXZ2ZGR6emR1ZXRta2VsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3ODYzMzAsImV4cCI6MjA3NzM2MjMzMH0.hW1SyZKQRzI-ghokMb-F5uccV52vxixE0aH78lNZ1F4"
```

### 3.2 Update `/utils/supabase/client.ts`

```typescript
import { createClient } from '@supabase/supabase-js'

const supabaseUrl = import.meta.env.VITE_SUPABASE_URL || 'https://djzexivvddzzduetmkel.supabase.co'
const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...'

export const supabase = createClient(supabaseUrl, supabaseKey)
```

**Benefits:**
- Easy to change credentials without code changes
- Separate dev/staging/prod environments
- More secure (no hardcoded secrets in repo)

---

## ‚úÖ Step 4: Verify Deployment

### 4.1 Check Build Logs

1. Go to Vercel Dashboard ‚Üí Your Project ‚Üí Deployments
2. Click latest deployment
3. Check "Building" tab for errors
4. Look for: ‚úÖ "Build Completed"

### 4.2 Test Your Deployed App

Visit your Vercel URL and test:

#### Test 1: Home Page Loads
- ‚úÖ Featured sensors section visible
- ‚úÖ No console errors
- ‚úÖ Images load correctly

#### Test 2: Authentication Works
1. Click "Sign In"
2. Switch to "Sign Up"
3. Create test account
4. ‚úÖ Should redirect to dashboard

#### Test 3: Backend Connection
1. Go to Dashboard
2. Try registering a sensor
3. ‚úÖ Should successfully create sensor
4. Check Network tab: calls to `djzexivvddzzduetmkel.supabase.co` should succeed

#### Test 4: Public Features
1. Sign out (or open incognito)
2. Go to `/public-sensors`
3. ‚úÖ Should see public sensors (if any exist)

### 4.3 Common Issues & Fixes

| Issue | Symptom | Fix |
|-------|---------|-----|
| **404 on routes** | Refreshing `/dashboard` shows 404 | Add rewrite rule to `vercel.json` |
| **Failed to fetch** | API calls fail | Check Supabase Edge Function is deployed |
| **Auth doesn't work** | Sign up/in fails | Verify env vars in Vercel, disable email confirmation in Supabase |
| **Blank page** | White screen, no errors | Check build logs, ensure `dist` folder generated |
| **Module not found** | Build fails | Run `npm install` locally, check all imports |

---

## üîê Step 5: Configure Supabase for Vercel Domain

### 5.1 Add Vercel URL to Supabase Auth

1. Go to [Supabase Dashboard](https://supabase.com/dashboard/project/djzexivvddzzduetmkel)
2. **Authentication** ‚Üí **URL Configuration**
3. Add your Vercel URL to **Site URL**:
   ```
   https://your-project.vercel.app
   ```
4. Add to **Redirect URLs**:
   ```
   https://your-project.vercel.app/**
   ```

**Why?** Supabase Auth needs to know which domains can use it.

### 5.2 Update CORS in Edge Function (If Needed)

Your Edge Function in `/supabase/functions/server/index.tsx` should already have:

```typescript
app.use('*', cors({
  origin: '*', // Or specify your domains
  allowMethods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowHeaders: ['Content-Type', 'Authorization'],
}))
```

If you want to restrict to specific domains:

```typescript
app.use('*', cors({
  origin: [
    'http://localhost:5173',
    'https://your-project.vercel.app',
    'https://your-production-domain.com'
  ],
  // ... rest
}))
```

Then redeploy Edge Function:
```bash
supabase functions deploy server
```

---

## üéØ Step 6: Set Up Custom Domain (Optional)

### 6.1 Add Domain in Vercel

1. Go to Project Settings ‚Üí Domains
2. Click "Add Domain"
3. Enter your domain: `sparked-sense.com`
4. Follow DNS configuration instructions

### 6.2 Update Supabase Auth URLs

Add your custom domain to Supabase (same as Step 5.1):
- Site URL: `https://sparked-sense.com`
- Redirect URLs: `https://sparked-sense.com/**`

---

## üîÑ Step 7: Set Up Continuous Deployment

### Auto-Deploy on Git Push

Vercel automatically deploys when you push to:
- **Main branch** ‚Üí Production
- **Other branches** ‚Üí Preview deployments

To configure:
1. Go to Project Settings ‚Üí Git
2. Set **Production Branch**: `main` (or `master`)
3. Enable **Preview Deployments** for all branches

### Environment Variables per Branch

You can set different env vars for:
- **Production** (main branch)
- **Preview** (feature branches)
- **Development** (local)

Example use case:
- Production: Real Supabase project
- Preview: Staging Supabase project

---

## üìä Step 8: Monitor Your Deployment

### Vercel Analytics

1. Go to Project ‚Üí Analytics
2. View:
   - Page views
   - Load times
   - Error rates
   - Geographic distribution

### Supabase Logs

1. Go to Supabase Dashboard ‚Üí Edge Functions ‚Üí server ‚Üí Logs
2. Monitor:
   - API calls
   - Errors
   - Performance

### Set Up Alerts (Optional)

**Vercel:**
- Project Settings ‚Üí Notifications
- Enable deployment notifications

**Supabase:**
- Project Settings ‚Üí Integrations
- Set up webhooks for errors

---

## üêõ Troubleshooting

### Build Fails on Vercel

**Error: "Module not found"**

```bash
# Fix: Ensure all dependencies are in package.json
npm install <missing-package> --save
git commit -am "Add missing dependency"
git push
```

**Error: "Command failed: npm run build"**

1. Test build locally:
   ```bash
   npm run build
   ```
2. Check for TypeScript errors
3. Fix errors and push

### Deployed App Shows Errors

**"Failed to fetch" errors:**
- ‚úÖ Verify Supabase Edge Function is deployed
- ‚úÖ Check Edge Function URL in `/lib/api.ts` matches your project ID
- ‚úÖ Test Edge Function directly: `curl https://djzexivvddzzduetmkel.supabase.co/functions/v1/make-server-a6d2d1a2/health`

**Authentication fails:**
- ‚úÖ Verify env vars are set in Vercel
- ‚úÖ Check Supabase URL configuration includes Vercel domain
- ‚úÖ Ensure email confirmation is disabled in Supabase

**Routes show 404:**
- ‚úÖ Verify `vercel.json` has rewrite rule
- ‚úÖ Check framework preset is set to "Vite"
- ‚úÖ Ensure output directory is `dist`

### Environment Variables Not Working

```bash
# Check if env vars are accessed correctly
# Vite uses import.meta.env, not process.env

# ‚úÖ Correct
const url = import.meta.env.VITE_SUPABASE_URL

# ‚ùå Wrong
const url = process.env.VITE_SUPABASE_URL
```

---

## üìö Complete Deployment Checklist

### Pre-Deployment
- [ ] Supabase Edge Function deployed
- [ ] Database migration applied
- [ ] Email confirmation disabled
- [ ] Code pushed to Git repository
- [ ] `vercel.json` created
- [ ] Environment variables documented

### Vercel Setup
- [ ] Project imported from Git
- [ ] Framework preset: Vite
- [ ] Environment variables added
- [ ] First deployment successful
- [ ] Custom domain added (if applicable)

### Post-Deployment
- [ ] Home page loads correctly
- [ ] Sign up/in works
- [ ] Dashboard accessible
- [ ] API calls succeed
- [ ] Public sensors visible
- [ ] No console errors
- [ ] Vercel domain added to Supabase Auth

### Optional
- [ ] Custom domain configured
- [ ] Analytics enabled
- [ ] Alerts set up
- [ ] Preview deployments configured

---

## üöÄ Quick Deploy Commands

```bash
# 1. Ensure Supabase is ready
supabase functions deploy server
supabase db push

# 2. Push code to GitHub
git add .
git commit -m "Prepare for Vercel deployment"
git push origin main

# 3. Deploy to Vercel (if using CLI)
vercel --prod

# 4. Test deployment
curl https://your-project.vercel.app
```

---

## üéØ Expected URLs After Deployment

| Service | URL | Purpose |
|---------|-----|---------|
| **Frontend (Vercel)** | `https://your-project.vercel.app` | React app |
| **Edge Function (Supabase)** | `https://djzexivvddzzduetmkel.supabase.co/functions/v1/make-server-a6d2d1a2/*` | API endpoints |
| **Database (Supabase)** | Internal (accessed via Edge Function) | PostgreSQL |
| **Auth (Supabase)** | Internal (accessed via SDK) | Authentication |

---

## üìù Next Steps After Deployment

1. **Test Thoroughly**
   - Create sensors
   - Generate data
   - Test public features
   - Check real-time updates

2. **Share Your App**
   - Send URL to testers
   - Gather feedback
   - Monitor usage

3. **Add Real Hardware**
   - Connect ESP8266/Arduino
   - Use activation code
   - Stream live data

4. **Scale Up**
   - Monitor Supabase usage
   - Upgrade plans if needed
   - Optimize performance

---

## üÜò Need Help?

### Resources
- [Vercel Documentation](https://vercel.com/docs)
- [Vite Deployment Guide](https://vitejs.dev/guide/static-deploy.html)
- [Supabase Edge Functions](https://supabase.com/docs/guides/functions)

### Common Support Issues
- Build fails: Check Vercel build logs
- Auth issues: Verify Supabase configuration
- API errors: Check Edge Function logs
- Routing issues: Verify `vercel.json` rewrites

---

**Last Updated:** 2025-01-30  
**Status:** Production Ready  
**Estimated Deploy Time:** 10-15 minutes  
**Difficulty:** Easy (with this guide)

---

## ‚úÖ Success Criteria

Your deployment is successful when:

1. ‚úÖ Vercel URL loads without errors
2. ‚úÖ All pages accessible (/, /dashboard, /public-sensors)
3. ‚úÖ Authentication works (sign up, sign in, sign out)
4. ‚úÖ Sensors can be registered and display data
5. ‚úÖ Public sensors visible on home page
6. ‚úÖ Real-time updates function correctly
7. ‚úÖ No errors in browser console
8. ‚úÖ All API calls return 200 OK

**Congratulations! Your Web3 IoT platform is now live! üéâ**
